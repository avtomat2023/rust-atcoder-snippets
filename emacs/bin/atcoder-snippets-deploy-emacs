#!/usr/bin/env python3
import json
import sys
import os
import re

dest_dir = sys.argv[1]
os.makedirs(dest_dir, exist_ok=True)

for key, snippet in json.load(sys.stdin).items():
    with open(os.path.join(dest_dir, key), 'w') as f:
        output = []
        for line in snippet['body']:
            if not re.match('\s*#\[doc', line):
                output.append(line
                              .replace('\\', '\\\\')
                              .replace('$', '\\$')
                              .replace('`', '\\`'))
        f.write('\n'.join(output))
